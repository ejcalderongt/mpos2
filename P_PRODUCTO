/*
   martes, 9 de junio de 202007:29:55
   User: sa
   Server: PROGRAX\SQLEXPRESS
   Database: MPOS2
   Application: 
*/

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODUCTO
	DROP CONSTRAINT FK_P_PRODUCTO_P_LINEA
GO
ALTER TABLE dbo.P_LINEA SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_LINEA', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_LINEA', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_LINEA', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODUCTO
	DROP CONSTRAINT FK_P_PRODUCTO_P_MARCA
GO
ALTER TABLE dbo.P_MARCA SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_MARCA', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_MARCA', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_MARCA', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODUCTO
	DROP CONSTRAINT FK_P_PRODUCTO_P_EMPRESA
GO
ALTER TABLE dbo.P_EMPRESA SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_EMPRESA', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_EMPRESA', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_EMPRESA', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
CREATE TABLE dbo.Tmp_P_PRODUCTO_1
	(
	CODIGO_PRODUCTO int NOT NULL IDENTITY (1, 1),
	CODIGO nvarchar(15) NOT NULL,
	CODIGO_TIPO nvarchar(1) NOT NULL,
	LINEA int NOT NULL,
	EMPRESA int NOT NULL,
	MARCA nvarchar(15) NOT NULL,
	CODBARRA nvarchar(30) NULL,
	DESCCORTA nvarchar(50) NOT NULL,
	DESCLARGA nvarchar(50) NOT NULL,
	COSTO float(53) NOT NULL,
	FACTORCONV float(53) NOT NULL,
	UNIDBAS nvarchar(15) NULL,
	UNIDMED nvarchar(15) NULL,
	UNIMEDFACT float(53) NOT NULL,
	UNIGRA nvarchar(15) NULL,
	UNIGRAFACT float(53) NOT NULL,
	DESCUENTO nvarchar(1) NULL,
	BONIFICACION nvarchar(1) NULL,
	IMP1 float(53) NOT NULL,
	IMP2 float(53) NOT NULL,
	IMP3 float(53) NOT NULL,
	VENCOMP nvarchar(50) NULL,
	DEVOL nvarchar(1) NULL,
	OFRECER nvarchar(1) NULL,
	RENTAB nvarchar(1) NULL,
	DESCMAX nvarchar(1) NULL,
	IVA nvarchar(15) NULL,
	CODBARRA2 nvarchar(30) NULL,
	CBCONV int NOT NULL,
	BODEGA nvarchar(15) NULL,
	SUBBODEGA nvarchar(15) NULL,
	PESO_PROMEDIO float(53) NOT NULL,
	MODIF_PRECIO bit NOT NULL,
	VIDEO nvarchar(MAX) NOT NULL,
	VENTA_POR_PESO bit NOT NULL,
	ES_PROD_BARRA bit NOT NULL,
	UNID_INV nvarchar(30) NOT NULL,
	VENTA_POR_PAQUETE bit NOT NULL,
	VENTA_POR_FACTOR_CONV bit NOT NULL,
	ES_SERIALIZADO bit NOT NULL,
	PARAM_CADUCIDAD int NOT NULL,
	PRODUCTO_PADRE int NOT NULL,
	FACTOR_PADRE float(53) NOT NULL,
	TIENE_INV bit NOT NULL,
	TIENE_VINETA_O_TUBO bit NOT NULL,
	PRECIO_VINETA_O_TUBO float(53) NOT NULL,
	ES_VENDIBLE bit NOT NULL,
	UNIGRASAP float(53) NOT NULL,
	UM_SALIDA nvarchar(25) NOT NULL,
	IMAGEN image NULL,
	TIEMPO_PREPARACION float(53) NULL,
	ACTIVO bit NULL
	)  ON [PRIMARY]
	 TEXTIMAGE_ON [PRIMARY]
GO
ALTER TABLE dbo.Tmp_P_PRODUCTO_1 SET (LOCK_ESCALATION = TABLE)
GO
ALTER TABLE dbo.Tmp_P_PRODUCTO_1 ADD CONSTRAINT
	DF_P_PRODUCTO_TIEMPO_PREPARACION DEFAULT 0 FOR TIEMPO_PREPARACION
GO
SET IDENTITY_INSERT dbo.Tmp_P_PRODUCTO_1 ON
GO
IF EXISTS(SELECT * FROM dbo.P_PRODUCTO)
	 EXEC('INSERT INTO dbo.Tmp_P_PRODUCTO_1 (CODIGO_PRODUCTO, CODIGO, CODIGO_TIPO, LINEA, EMPRESA, MARCA, CODBARRA, DESCCORTA, DESCLARGA, COSTO, FACTORCONV, UNIDBAS, UNIDMED, UNIMEDFACT, UNIGRA, UNIGRAFACT, DESCUENTO, BONIFICACION, IMP1, IMP2, IMP3, VENCOMP, DEVOL, OFRECER, RENTAB, DESCMAX, IVA, CODBARRA2, CBCONV, BODEGA, SUBBODEGA, PESO_PROMEDIO, MODIF_PRECIO, VIDEO, VENTA_POR_PESO, ES_PROD_BARRA, UNID_INV, VENTA_POR_PAQUETE, VENTA_POR_FACTOR_CONV, ES_SERIALIZADO, PARAM_CADUCIDAD, PRODUCTO_PADRE, FACTOR_PADRE, TIENE_INV, TIENE_VINETA_O_TUBO, PRECIO_VINETA_O_TUBO, ES_VENDIBLE, UNIGRASAP, UM_SALIDA, IMAGEN, ACTIVO)
		SELECT CODIGO_PRODUCTO, CODIGO, CODIGO_TIPO, LINEA, EMPRESA, MARCA, CODBARRA, DESCCORTA, DESCLARGA, COSTO, FACTORCONV, UNIDBAS, UNIDMED, UNIMEDFACT, UNIGRA, UNIGRAFACT, DESCUENTO, BONIFICACION, IMP1, IMP2, IMP3, VENCOMP, DEVOL, OFRECER, RENTAB, DESCMAX, IVA, CODBARRA2, CBCONV, BODEGA, SUBBODEGA, PESO_PROMEDIO, MODIF_PRECIO, VIDEO, VENTA_POR_PESO, ES_PROD_BARRA, UNID_INV, VENTA_POR_PAQUETE, VENTA_POR_FACTOR_CONV, ES_SERIALIZADO, PARAM_CADUCIDAD, PRODUCTO_PADRE, FACTOR_PADRE, TIENE_INV, TIENE_VINETA_O_TUBO, PRECIO_VINETA_O_TUBO, ES_VENDIBLE, UNIGRASAP, UM_SALIDA, IMAGEN, ACTIVO FROM dbo.P_PRODUCTO WITH (HOLDLOCK TABLOCKX)')
GO
SET IDENTITY_INSERT dbo.Tmp_P_PRODUCTO_1 OFF
GO
ALTER TABLE dbo.P_PRODPRECIO
	DROP CONSTRAINT FK_P_PRODPRECIO_P_PRODUCTO
GO
ALTER TABLE dbo.P_PRODMENU
	DROP CONSTRAINT FK__P_PRODMEN__CODIG__24DD5622
GO
ALTER TABLE dbo.P_PRODMENUOPC_DET
	DROP CONSTRAINT FK__P_PRODMEN__CODIG__2F5AE495
GO
ALTER TABLE dbo.P_PRODCOMBO
	DROP CONSTRAINT FK_P_PRODCOMBO_P_PRODUCTO
GO
ALTER TABLE dbo.P_FACTORCONV
	DROP CONSTRAINT FK_P_FACTORCONV_P_PRODUCTO
GO
DROP TABLE dbo.P_PRODUCTO
GO
EXECUTE sp_rename N'dbo.Tmp_P_PRODUCTO_1', N'P_PRODUCTO', 'OBJECT' 
GO
ALTER TABLE dbo.P_PRODUCTO ADD CONSTRAINT
	PK_P_PRODUCTO_1 PRIMARY KEY CLUSTERED 
	(
	CODIGO_PRODUCTO
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
ALTER TABLE dbo.P_PRODUCTO ADD CONSTRAINT
	FK_P_PRODUCTO_P_EMPRESA FOREIGN KEY
	(
	EMPRESA
	) REFERENCES dbo.P_EMPRESA
	(
	EMPRESA
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODUCTO ADD CONSTRAINT
	FK_P_PRODUCTO_P_MARCA FOREIGN KEY
	(
	MARCA
	) REFERENCES dbo.P_MARCA
	(
	CODIGO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODUCTO ADD CONSTRAINT
	FK_P_PRODUCTO_P_LINEA FOREIGN KEY
	(
	LINEA
	) REFERENCES dbo.P_LINEA
	(
	CODIGO_LINEA
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_PRODUCTO', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_PRODUCTO', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_PRODUCTO', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_FACTORCONV ADD CONSTRAINT
	FK_P_FACTORCONV_P_PRODUCTO FOREIGN KEY
	(
	PRODUCTO
	) REFERENCES dbo.P_PRODUCTO
	(
	CODIGO_PRODUCTO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_FACTORCONV SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_FACTORCONV', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_FACTORCONV', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_FACTORCONV', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODCOMBO ADD CONSTRAINT
	FK_P_PRODCOMBO_P_PRODUCTO FOREIGN KEY
	(
	PRODUCTO
	) REFERENCES dbo.P_PRODUCTO
	(
	CODIGO_PRODUCTO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODCOMBO SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_PRODCOMBO', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_PRODCOMBO', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_PRODCOMBO', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODMENUOPC_DET ADD CONSTRAINT
	FK__P_PRODMEN__CODIG__2F5AE495 FOREIGN KEY
	(
	CODIGO_PRODUCTO
	) REFERENCES dbo.P_PRODUCTO
	(
	CODIGO_PRODUCTO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODMENUOPC_DET SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_PRODMENUOPC_DET', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_PRODMENUOPC_DET', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_PRODMENUOPC_DET', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODMENU ADD CONSTRAINT
	FK__P_PRODMEN__CODIG__24DD5622 FOREIGN KEY
	(
	CODIGO_PRODUCTO
	) REFERENCES dbo.P_PRODUCTO
	(
	CODIGO_PRODUCTO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODMENU SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_PRODMENU', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_PRODMENU', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_PRODMENU', 'Object', 'CONTROL') as Contr_Per BEGIN TRANSACTION
GO
ALTER TABLE dbo.P_PRODPRECIO ADD CONSTRAINT
	FK_P_PRODPRECIO_P_PRODUCTO FOREIGN KEY
	(
	CODIGO_PRODUCTO
	) REFERENCES dbo.P_PRODUCTO
	(
	CODIGO_PRODUCTO
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.P_PRODPRECIO SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
select Has_Perms_By_Name(N'dbo.P_PRODPRECIO', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.P_PRODPRECIO', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.P_PRODPRECIO', 'Object', 'CONTROL') as Contr_Per 
